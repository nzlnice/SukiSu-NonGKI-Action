name: Build Non-GKI Kernel with Sukisu

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04
    env:
      CCACHE_COMPILERCHECK: "%compiler% -dumpmachine; %compiler% -dumpversion"
      CCACHE_NOHASHDIR: "true"
      CCACHE_HARDLINK: "true"
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git bc bison flex libssl-dev build-essential libelf-dev libncurses5-dev zip ccache wget curl python3 lz4 dwarves device-tree-compiler

      - name: Load Configuration
        run: |
          if [ -f config.build ]; then
            source config.build
          else
            echo "Error: config.build not found!" && exit 1
          fi
          echo "KERNEL_REPO=${KERNEL_REPO}" >> $GITHUB_ENV
          echo "KERNEL_BRANCH=${KERNEL_BRANCH}" >> $GITHUB_ENV
          echo "ENABLE_SUSFS=${ENABLE_SUSFS}" >> $GITHUB_ENV
          echo "CLANG_VERSION=${CLANG_VERSION}" >> $GITHUB_ENV
          echo "CLANG_URL=${CLANG_URL}" >> $GITHUB_ENV
          echo "LLD_VERSION=${LLD_VERSION}" >> $GITHUB_ENV
          echo "LLD_URL=${LLD_URL}" >> $GITHUB_ENV
          echo "DEFCONFIG_PATH=${DEFCONFIG_PATH}" >> $GITHUB_ENV
          echo "KERNEL_IMAGE_NAME=${KERNEL_IMAGE_NAME:-Image.gz-dtb}" >> $GITHUB_ENV
          echo "BUILD_TIME=$(TZ=Asia/Shanghai date "+%Y%m%d%H%M")" >> $GITHUB_ENV

      - name: Download Toolchains
        run: |
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh ${{ env.CLANG_VERSION }}
          
          sudo apt-get install -y gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi
          
          sudo apt-get install -y clang-${{ env.CLANG_VERSION }} lld-${{ env.CLANG_VERSION }} llvm-${{ env.CLANG_VERSION }}
          
          sudo update-alternatives --install /usr/bin/clang clang /usr/bin/clang-${{ env.CLANG_VERSION }} 100
          sudo update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-${{ env.CLANG_VERSION }} 100
          sudo update-alternatives --install /usr/bin/ld.lld ld.lld /usr/bin/ld.lld-${{ env.CLANG_VERSION }} 100
          sudo update-alternatives --install /usr/bin/llvm-nm llvm-nm /usr/bin/llvm-nm-${{ env.CLANG_VERSION }} 100
          sudo update-alternatives --install /usr/bin/llvm-objcopy llvm-objcopy /usr/bin/llvm-objcopy-${{ env.CLANG_VERSION }} 100
          sudo update-alternatives --install /usr/bin/llvm-strip llvm-strip /usr/bin/llvm-strip-${{ env.CLANG_VERSION }} 100
          
          sudo update-alternatives --set clang /usr/bin/clang-${{ env.CLANG_VERSION }}
          sudo update-alternatives --set clang++ /usr/bin/clang++-${{ env.CLANG_VERSION }}
          sudo update-alternatives --set ld.lld /usr/bin/ld.lld-${{ env.CLANG_VERSION }}

          echo "CROSS_COMPILE=aarch64-linux-gnu-" >> $GITHUB_ENV
          echo "CROSS_COMPILE_ARM32=arm-linux-gnueabi-" >> $GITHUB_ENV
          echo "ARCH=arm64" >> $GITHUB_ENV

          echo "=== Toolchain Versions ==="
          clang --version
          ld.lld --version
          aarch64-linux-gnu-gcc --version

      - name: Clone Kernel Source
        run: |
          git clone --depth=1 -b "${{ env.KERNEL_BRANCH }}" "${{ env.KERNEL_REPO }}" kernel-source
          cd kernel-source

      - name: Integrate Sukisu and Apply Patches
        run: |
          cd kernel-source
          if [ "${{ env.ENABLE_SUSFS }}" = "yes" ] || [ "${{ env.ENABLE_SUSFS }}" = "true" ]; then
            BRANCH="susfs-main"
          else
            BRANCH="nongki"
          fi
          curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" | bash -s $BRANCH
          git clone https://github.com/jonjeexe/KernelSU_Patches Patches
          curl -O https://raw.githubusercontent.com/jonjeexe/KernelSU_Patches/refs/heads/non-GKI/Patch.sh
          bash Patch.sh

      - name: Add KernelSU Config to Defconfig
        run: |
          cd kernel-source
          DEFCONFIG_FILE="arch/arm64/configs/${{ env.DEFCONFIG_PATH }}"
          echo "" >> $DEFCONFIG_FILE
          echo "# KernelSU" >> $DEFCONFIG_FILE
          echo "CONFIG_KSU=y" >> $DEFCONFIG_FILE
          echo "CONFIG_KPROBES=y" >> $DEFCONFIG_FILE
          echo "CONFIG_HAVE_KPROBES=y" >> $DEFCONFIG_FILE
          echo "CONFIG_KPROBE_EVENTS=y" >> $DEFCONFIG_FILE
          echo "CONFIG_OVERLAY_FS=y" >> $DEFCONFIG_FILE

      - name: Prepare Build
        run: |
          cd kernel-source
          mkdir -p out
          make ARCH=arm64 O=out CROSS_COMPILE=aarch64-linux-gnu- ${{ env.DEFCONFIG_PATH }}

      - name: Build Kernel
        run: |
          cd kernel-source
          unset CFLAGS
          unset CXXFLAGS
          unset LDFLAGS
          
          make ARCH=arm64 O=out \
            CC=clang \
            LD=ld.lld \
            CROSS_COMPILE=aarch64-linux-gnu- \
            CROSS_COMPILE_ARM32=arm-linux-gnueabi- \
            -j$(nproc --all)

      - name: Check Kernel Output
        run: |
          cd kernel-source
          if [ -f out/arch/arm64/boot/${{ env.KERNEL_IMAGE_NAME }} ]; then
            echo "KERNEL_BUILD_SUCCESS=true" >> $GITHUB_ENV
            echo "Kernel build successful!"
          else
            echo "Kernel output file not found!"
            exit 1
          fi

      - name: Prepare AnyKernel3
        if: env.KERNEL_BUILD_SUCCESS == 'true'
        run: |
          git clone https://github.com/osm0sis/AnyKernel3 --depth=1 AnyKernel3
          sed -i 's/do.devicecheck=1/do.devicecheck=0/g' AnyKernel3/anykernel.sh
          sed -i 's!BLOCK=/dev/block/platform/omap/omap_hsmmc.0/by-name/boot;!BLOCK=auto;!g' AnyKernel3/anykernel.sh
          sed -i 's/IS_SLOT_DEVICE=0;/is_slot_device=auto;/g' AnyKernel3/anykernel.sh
          
          cp kernel-source/out/arch/arm64/boot/${{ env.KERNEL_IMAGE_NAME }} AnyKernel3/
          
          if [ -f kernel-source/out/arch/arm64/boot/dtbo.img ]; then
            cp kernel-source/out/arch/arm64/boot/dtbo.img AnyKernel3/
            echo "DTBO_COPIED=true" >> $GITHUB_ENV
          fi
          
          rm -rf AnyKernel3/.git* AnyKernel3/README.md

      - name: Create Flashable Zip
        if: env.KERNEL_BUILD_SUCCESS == 'true'
        run: |
          cd AnyKernel3
          zip -r9 kernel-flashable-${{ env.BUILD_TIME }}.zip * -x .git*

      - name: Upload Kernel Image
        if: env.KERNEL_BUILD_SUCCESS == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: kernel-image-${{ env.BUILD_TIME }}
          path: kernel-source/out/arch/arm64/boot/${{ env.KERNEL_IMAGE_NAME }}

      - name: Upload AnyKernel3 Zip
        if: env.KERNEL_BUILD_SUCCESS == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: anykernel3-flashable-${{ env.BUILD_TIME }}
          path: AnyKernel3/kernel-flashable-${{ env.BUILD_TIME }}.zip

      - name: Upload DTBO Image
        if: env.DTBO_COPIED == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: dtbo-image-${{ env.BUILD_TIME }}
          path: AnyKernel3/dtbo.img